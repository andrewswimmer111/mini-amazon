{% extends "base.html" %}

{% block content %}

<br><br>

<h2>Products for sale:</h2>

{% if current_user.is_authenticated %}
  <a href="{{ url_for('cart.view_cart') }}" class="btn btn-primary mb-3">View Cart</a>
{% endif %}

<div> Filter for the kth most expensive items </div>
<form method="get" action="{{ url_for('index.index') }}">
  <input 
    type="number" 
    name="top_k" 
    value="{{ k or '' }}" 
    min=0 
    max="{{ n }}" 
    step="1"
  >
  <button type="submit">Apply</button>
  <button type="button" id="reset-btn" data-url="{{ url_for('index.index') }}">
    Reset
  </button>


</form>

<br><br>

<br><br>
<h2>View a Sellerâ€™s Inventory</h2>

<form id="seller-form" onsubmit="goToSeller(event)">
  <label for="seller-id">Enter Seller ID:</label>
  <input 
    type="number" 
    id="seller-id" 
    name="seller_id" 
    min="0" 
    placeholder="e.g. 0"
    required
  >
  <button type="submit">View Inventory</button>
</form>

<script>
  function goToSeller(event) {
    event.preventDefault();
    const id = document.getElementById('seller-id').value.trim();
    if (id !== '') {
      // redirect to the seller inventory view
      window.location.href = `/seller/${id}/inventory/view`;
    }
  }
</script>

<br><br>

<table class='table table-hover table-bordered container'>
  <thead class="thead-dark">
    <tr>
      <th scope="col">Product ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Product Description</th>
      <th scope="col">Product Category</th>
      <th scope="col">Price</th>
      <th scope="col">Add</th>
    </tr>
  </thead>
  <tbody>
    {% for product in avail_products%}
      <tr>
        <th scope="row">{{product.id}}</th>
        <td>{{product.name}}</td>
        <td>{{product.description}}</td>
        <td>{{product.category}}</td>
        <td>{{product.price}}</td>
        <td>
          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('cart.add_to_cart') }}" style="display:inline-block">
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <input type="number" name="quantity" value="1" min="1" style="width:70px" aria-label="quantity">
              <button type="submit" class="btn btn-sm btn-success">Add</button>
            </form>
          {% else %}
            <a href="{{ url_for('users.login') }}">Log in to add</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<br><br>
{% if current_user.is_authenticated %}
<h2>Your recent purchases:</h2>
<table class='table table-hover table-bordered container'>
  <thead class="thead-dark">
    <tr>
      <th scope="col">Purchase ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
    </tr>
  </thead>
  <tbody>
    {% for purchase in purchase_history%}
      <tr>
        <th scope="row">{{purchase.id}}</th>
        <td>{{purchase.pid}}</td>
        <td>{{purchase.time_purchased}}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p><a href="{{ url_for('users.login') }}">Log in</a> to see your purchase history!</p>
{% endif %}


<script>
  document.getElementById('reset-btn').addEventListener('click', (e) => {
    window.location.href = e.target.dataset.url;
  });
</script>

{% endblock %}